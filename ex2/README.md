# Визуализация таблиц страниц процесса

Не совсем не совсем уверен, что я сделал именно то, что требовалось. Вот такая у меня получилась визуализация страниц памяти слипа (то что слип не принципиально, просто у него меньше страниц памяти и это смотрится лучше): 

<img src="https://github.com/KushnerovMS/sys-labs/blob/main/ex2/sample.svg" width="1000" height="800"/>

## Kernel module

Для возможности получать "развертки" пути прохождения от `PGD` до физического адреса страницы я написал `kernel module`. Этот модуль создает в `/proc` файл `page_table_module`.
При записи в файл надо передать `pid` процесса, и виртуальный адрес интересуемой страницы в виде
```c
struct pt_module_write {
	pid_t pid;
	uint64_t vaddr;
};
```
При чтении передается информация в виде следующей структурки:
```c
#define PAGE_TABLE_LEVELS 5
struct unfolding_entry {
	uint64_t base; /* адресс таблицы */
	uint64_t ptr;  /* адрес вхождения в таблицу */
};
struct pt_module_read {
	pid_t pid; /* пид процесса */
	uint64_t vaddr; /* виртуальный адрес интересуемой страници */
	struct unfolding_entry unfolding[PAGE_TABLE_LEVELS];
	uint64_t phys_addr;
};
```

### build

```bash
cd page_table_module
```
Собрать
```bash
make
```
Загрузить в ядро
```bash
sudo insmod page_table_module.ko
```
Выгрузить
```bash
sudo rmmod page_table_module
```

Возможно есть более простой путь, но я его не нашел.

## Визуализватор

Программа-визуализатор парсит `/proc/<pid>/maps` и пробегается по полученным адресам в `/proc/page_table_module`.
Все валидные адреса она запоминает и далее визуализирует с помощью `graphviz`.
Остановился на следующем виде графа:
Кластерами показаны уровни (по примеру можно видеть, что в моей системе нету `p4d` уровня).
Во всех уровнях кроме последнего таблицы представлены таким образом, что самая верхняя ячейка есть адрес таблици, остальные ячейки -- адреса интересных нам вхождений. Стрелками показаны указатели на следующие по уровню таблици (из самой первой ячейки тоже может быть стрелка).
На `pte` уровне я добавил рядом с адресами вхождений физические адреса страниц памяти и информацию из `/proc/<pid>/maps` для наглядности.

### build

```bash
mkdir build; cd build
```
```bash
cmake ..
```
```bash
cmake --build .
```

### usage

```bash
./pm_viz <pid>
```

## Отзыв

Интересное задание. Сначала придется разобраться в устройстве таблиц и страниц памяти. Потом придется понять, как получить искомые адреса. Для этого, на сколько я понял, надо написать `kernel module`, так как из юзер-спэйса физического адреса и адресов таблиц не получить. Для этого человек, по хорошему, должен еще поднять тестовую виртуальную машину для безопасного написания модуля. Далее надо найти способ подружить основную программу/скрипт с ядерным модулем.
Как по мне -- самое разносторонней и объемное задание (если конечно эти этапы реально надо было делать).
